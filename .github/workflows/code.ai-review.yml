name: AI Code Review

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  actions: read

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: ${{ github.repository }}-${{ github.event.number || github.event.issue.number || github.head_ref || github.sha }}-${{ github.workflow }}-ai-review
  cancel-in-progress: true

jobs:
  review:
    environment: dev
    runs-on: ubuntu-latest
    # Only run if the comment contains "/ai-review" or if it's a PR review comment
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/ai-review')) ||
      github.event_name == 'pull_request_review_comment'
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let pr;
            if (context.eventName === 'issue_comment') {
              // Get PR from issue comment
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
            } else {
              // Get PR from review comment
              pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
              });
            }
            core.setOutput('number', pr.data.number);
            core.setOutput('head_sha', pr.data.head.sha);

      - name: Clean up old AI review comments
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
            });

            // Find comments from the bot (GitHub Actions bot or specific user)
            const botComments = comments.data.filter(comment =>
              comment.user.login === 'github-actions[bot]' &&
              (comment.body.includes('## Summary') ||
               comment.body.includes('AI Code Review') ||
               comment.body.includes('## Changes'))
            );

            // Delete old bot comments
            for (const comment of botComments) {
              try {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
                console.log(`Deleted comment ${comment.id}`);
              } catch (error) {
                console.log(`Failed to delete comment ${comment.id}: ${error.message}`);
              }
            }

            // Also clean up review comments if any
            try {
              const reviewComments = await github.rest.pulls.listReviewComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }},
              });

              const botReviewComments = reviewComments.data.filter(comment =>
                comment.user.login === 'github-actions[bot]'
              );

              for (const comment of botReviewComments) {
                try {
                  await github.rest.pulls.deleteReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: comment.id,
                  });
                  console.log(`Deleted review comment ${comment.id}`);
                } catch (error) {
                  console.log(`Failed to delete review comment ${comment.id}: ${error.message}`);
                }
              }
            } catch (error) {
              console.log(`Error cleaning up review comments: ${error.message}`);
            }

      - name: React to trigger comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT }}:role/${{ vars.ROLE_NAME_TO_ASSUME }}
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          role-duration-seconds: 7200
      - name: PR Review
        uses: tmokmss/bedrock-pr-reviewer@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          debug: false
          summarize: true
          summarize_release_notes: true
          review_file_diff: |
            - Do NOT provide general feedback, summaries, explanations of changes, statements of following existing patterns, or praises for making good additions.
            - Focus solely on offering specific, objective insights based on the given context and refrain from making broad comments about potential impacts on the system or question intentions behind the changes.
            - Comments should have actionable changes
            - Disregard formatting, stylistic, or import issues, since this should be taken care of with linters and tests
            - Ignore verification comments unless there is evidence that contradicts the statement.
            - Ignore functional imports for test classes. Other classes should not import within functions
          review_simple_changes: false
          review_comment_lgtm: false
          bedrock_light_model: ${{ vars.BEDROCK_LIGHT_MODEL }}
          bedrock_heavy_model: ${{ vars.BEDROCK_HEAVY_MODEL }}
